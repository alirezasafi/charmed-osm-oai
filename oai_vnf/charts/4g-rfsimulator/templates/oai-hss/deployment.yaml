apiVersion: apps/v1
kind: Deployment
metadata:
  name: oai-hss
  labels:
    chart: oai-hss
    app: oai-hss
spec:
  selector:
    matchLabels:
      app: oai-hss
  template:
    metadata:
      labels:
        app: oai-hss
      annotations:
        k8s.v1.cni.cncf.io/networks: '[
          {
            "name": "rfsim4g-core-private",
            "interface": "eth1",
            "ips": ["{{ .Values.oaiHss.networks.privateIpAddr }}"],
            "default": true
          },
          {
            "name": "rfsim4g-core-public",
            "interface": "eth2",
            "ips": ["{{ .Values.oaiHss.networks.publicIpAddr }}"]
          }
        ]'
    spec:
      affinity:
{{ toYaml .Values.affinity.coreAffinity | indent 8 }}
      initContainers:
        - name: init-cassandra
          image: "busybox:1.28"
          imagePullPolicy: {{ .Values.imagePullPolicy | quote }}
          command:  ['sh', '-c', "sleep {{ .Values.oaiHss.initContainer.delayInit }} && until nslookup cassandra-svc; do echo waiting for cassandra; sleep 2; done"]
          resources:
            requests:
              memory: 10Mi
              cpu: 10m
      containers:
        - name: oai-hss
          image: "{{ .Values.oaiHss.image }}:{{ .Values.oaiHss.imageTag }}"
          imagePullPolicy: {{ .Values.imagePullPolicy | quote }}
          securityContext:
            privileged: true
          ports:
          - name: http1
            containerPort: 9042
            protocol: TCP
          - name: http2
            containerPort: 5868
            protocol: TCP
          - name: http3
            containerPort: 9080
            protocol: TCP
          - name: http4
            containerPort: 9081
            protocol: TCP
          env:
          - name: REALM
            value: "openairinterface.org"
          - name: HSS_FQDN
            value: "hss.openairinterface.org"
          - name: PREFIX
            value: "/openair-hss/etc"
          - name: cassandra_Server_IP
            value: "{{ .Values.cassandra.networks.ipAddr }}"
          - name: OP_KEY
            value: "1006020f0a478bf6b699f15c062e42b3"
          - name: LTE_K
            value: "fec86ba6eb707ed08905757b1bb44b8f"
          - name: APN1
            value: "oai.ipv4"
          - name: APN2
            value: "internet"
          - name: FIRST_IMSI
            value: "208960100000001"
          - name: NB_USERS
            value: "10"
          livenessProbe:
            exec:
              command:
              - /bin/bash
              - -c
              - "pgrep oai_hss"
            initialDelaySeconds: 10
            timeoutSeconds: 5
            periodSeconds: 20
            successThreshold: 1
            failureThreshold: 10
          readinessProbe:
            exec:
              command:
              - /bin/bash
              - -c
              - "pgrep oai_hss"
            initialDelaySeconds: 10
            timeoutSeconds: 5
            periodSeconds: 20
            successThreshold: 1
            failureThreshold: 10
          {{- if .Values.oaiHss.resources.enabled }}
          resources:
            requests:
{{ toYaml .Values.oaiHss.resources.requests | indent 14 }}
            limits:
{{ toYaml .Values.oaiHss.resources.limits | indent 14 }}
          {{- end }}