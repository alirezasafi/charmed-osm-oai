{{- range .Values.ue }}
{{- if .enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oai-{{ .name }}
  labels:
    chart: oai-{{ .name }}
    app: oai-{{ .name }}
spec:
  selector:
    matchLabels:
      app: oai-{{ .name }}
  template:
    metadata:
      labels:
        app: oai-{{ .name }}
      annotations:
        k8s.v1.cni.cncf.io/networks: '[
          {{- if $.Values.distributedMode }}
          {
            "name": "rfsim4g-ran-private",
            "interface": "eth1",
            "ips": ["{{ .networks.ranIpAddr }}"],
            "default-route": ["{{ $.Values.networks.rfsim4gPrivateRanGateway }}"]
          }
          {{- else }}
          {
            "name": "rfsim4g-core-public",
            "interface": "eth1",
            "ips": ["{{ .networks.pubCoreIpAddr }}"],
            "default-route": ["{{ $.Values.networks.rfsim4gPublicCoreGateway }}"]
          }
          {{- end }}
        ]'
    spec:
      affinity:
      {{- if $.Values.distributedMode }}
{{ toYaml $.Values.affinity.ranAffinity | indent 8 }}
      {{- else }}
{{ toYaml $.Values.affinity.coreAffinity | indent 8 }}
      {{- end }}
      initContainers:
        - name: init-enb
          image: "busybox:1.28"
          imagePullPolicy: {{ $.Values.imagePullPolicy | quote }}
          command:  ['sh', '-c', "sleep {{ .delayInit }}"]
          resources:
            requests:
              memory: 10Mi
              cpu: 10m
      containers:
        - name: {{ .name }}
          securityContext:
            privileged: true
          image: "{{ $.Values.ueCommons.image }}:{{ $.Values.ueCommons.imageTag }}"
          imagePullPolicy: {{ $.Values.imagePullPolicy | quote }}
          ports:
            - name: http1
              containerPort: 10000
              protocol: TCP
          env:
          - name: TZ
            value: Europe/Paris
          - name: HOSTNAME
            value: oai_{{ .name }}
          - name: RFSIMULATOR
            {{- if $.Values.distributedMode }}
            value: "{{ $.Values.enb.networks.ranIpAddr }}"
            {{- else }}
            value: "{{ $.Values.enb.networks.pubCoreIpAddr }}"
            {{- end }}
          - name: MCC
            value: "208"
          - name: MNC
            value: "96"
          - name: SHORT_IMSI
            value: "{{ .env.shortImsi }}"
          - name: LTE_KEY
            value: "fec86ba6eb707ed08905757b1bb44b8f"
          - name: OPC
            value: "c42449363bbad02b66d16bc975d77cc1"
          - name: MSISDN
            value: "001011234561010"
          - name: HPLMN
            value: "20896"
          - name: USE_ADDITIONAL_OPTIONS
            value: "--rfsim -C 2680000000 -r 25 --ue-rxgain 140 --ue-txgain 120 --nokrnmod 1 --log_config.global_log_options level,nocolor,time"
          livenessProbe:
            exec:
              command:
              - /bin/bash
              - -c
              - "pgrep lte-uesoftmodem"
            initialDelaySeconds: 10
            timeoutSeconds: 5
            periodSeconds: 10
            successThreshold: 1
            failureThreshold: 5
          readinessProbe:
            exec:
              command:
              - /bin/bash
              - -c
              - "pgrep lte-uesoftmodem"
            initialDelaySeconds: 10
            timeoutSeconds: 5
            periodSeconds: 10
            successThreshold: 1
            failureThreshold: 5
          {{- if $.Values.ueCommons.resources.enabled }}
          resources:
            requests:
{{ toYaml $.Values.ueCommons.resources.requests | indent 14 }}
            limits:
{{ toYaml $.Values.ueCommons.resources.limits | indent 14 }}
          {{- end }}
      volumes:
      - configMap:
          defaultMode: 0664
          name: ue-config
        name: ue-config
---
{{- end }}
{{- end }}
